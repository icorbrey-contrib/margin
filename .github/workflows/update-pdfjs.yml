name: Update PDF.js

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for PDF.js update
        id: check
        run: |
          LATEST=$(curl -sL "https://api.github.com/repos/mozilla/pdf.js/releases/latest" \
            | grep '"tag_name"' | head -1 | sed -E 's/.*"v([^"]+)".*/\1/')
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"

          if [ -f extension/public/pdfjs/build/pdf.mjs ]; then
            CURRENT=$(grep -oP "pdfjsVersion = '[^']+'" extension/public/pdfjs/build/pdf.mjs | head -1 | sed "s/pdfjsVersion = '//;s/'//")
          fi
          CURRENT="${CURRENT:-unknown}"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

          if [ "$LATEST" = "$CURRENT" ]; then
            echo "up_to_date=true" >> "$GITHUB_OUTPUT"
            echo "PDF.js is already at v${CURRENT}"
          else
            echo "up_to_date=false" >> "$GITHUB_OUTPUT"
            echo "Update available: v${CURRENT} â†’ v${LATEST}"
          fi

      - name: Run update script
        if: steps.check.outputs.up_to_date == 'false'
        run: |
          cd extension
          chmod +x tools/update-pdfjs.sh
          ./tools/update-pdfjs.sh "${{ steps.check.outputs.latest }}"

      - name: Create Pull Request
        if: steps.check.outputs.up_to_date == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(extension): update PDF.js to v${{ steps.check.outputs.latest }}"
          title: "Update PDF.js to v${{ steps.check.outputs.latest }}"
          body: |
            Automated update of the bundled PDF.js viewer.

            - **Previous version:** v${{ steps.check.outputs.current }}
            - **New version:** v${{ steps.check.outputs.latest }}
            - [Release notes](https://github.com/mozilla/pdf.js/releases/tag/v${{ steps.check.outputs.latest }})

            Patches applied automatically by `extension/tools/update-pdfjs.sh`:
            - Origin check bypass in `viewer.mjs`
            - Init script injection in `viewer.html`
          branch: chore/update-pdfjs-${{ steps.check.outputs.latest }}
          labels: dependencies
